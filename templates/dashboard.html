{% extends "base_dashboard.html" %}

{% block title %}داشبورد مدیریت پمپ‌ها{% endblock %}

{% block extra_css %}
<style>
    .pump-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .pump-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    .pump-on {
        border-color: #28a745 !important;
        background: linear-gradient(135deg, #f8fff9 0%, #e8f5e9 100%);
    }
    .pump-off {
        border-color: #dc3545 !important;
        background: linear-gradient(135deg, #fff8f8 0%, #ffeaea 100%);
    }
    .pump-unknown {
        border-color: #6c757d !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    .btn-action {
        font-weight: bold;
        transition: all 0.2s ease;
    }
    .btn-action:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .pump-inactive {
        border-color: #6c757d !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        opacity: 0.7;
    }

    .pump-maintenance {
        border-color: #ffc107 !important;
        background: linear-gradient(135deg, #fff9e6 0%, #ffeaa7 100%);
    }
</style>
{% endblock %}

{% block content %}
<!-- منوی گزارش‌ها -->
<div class="bg-light border-bottom py-3">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h4 class="mb-0 text-primary">
                    <i class="bi bi-speedometer2"></i>
                    وضعیت آنلاین پمپ‌ها
                </h4>
            </div>
        </div>
    </div>
</div>

<!-- محتوای اصلی -->
<div class="container mt-4">
   
    <!-- کارت‌های پمپ‌ها -->
    <div class="row" id="pumps-container">
        {% for pump in pumps %}
        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
            <div class="card pump-card 
                {% if pump.well_status == 'active' %}
                    {{ 'pump-on' if pump.status and pump.has_history > 0 else 'pump-off' if not pump.status and pump.has_history > 0 else 'pump-unknown' }}
                {% elif pump.well_status == 'inactive' %}
                    pump-inactive
                {% elif pump.well_status == 'maintenance' %}
                    pump-maintenance
                {% else %}
                    pump-unknown
                {% endif %} h-100">
                
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-water-pump"></i>
                        پمپ {{ pump.pump_number }}
                    </h6>
                    <span class="status-badge badge 
                        {% if pump.well_status == 'active' %}
                            {{ 'bg-success' if pump.status and pump.has_history > 0 else 'bg-danger' if not pump.status and pump.has_history > 0 else 'bg-secondary' }}
                        {% elif pump.well_status == 'inactive' %}
                            bg-secondary
                        {% elif pump.well_status == 'maintenance' %}
                            bg-warning
                        {% else %}
                            bg-dark
                        {% endif %}">
                        
                        {% if pump.well_status == 'active' %}
                            {% if pump.has_history > 0 %}
                                {% if pump.status %}
                                    <i class="bi bi-power"></i> روشن
                                {% else %}
                                    <i class="bi bi-power-off"></i> خاموش
                                {% endif %}
                            {% else %}
                                <i class="bi bi-question-circle"></i> بدون تاریخچه
                            {% endif %}
                        {% elif pump.well_status == 'inactive' %}
                            <i class="bi bi-x-circle"></i> غیرفعال
                        {% elif pump.well_status == 'maintenance' %}
                            <i class="bi bi-tools"></i> در حال تعمیر
                        {% else %}
                            <i class="bi bi-question-circle"></i> نامشخص
                        {% endif %}
                    </span>
                </div>
                
                <div class="card-body">
                    <h6 class="card-title">{{ pump.name }}</h6>
                    <p class="card-text text-muted small">
                        <i class="bi bi-geo-alt"></i>
                        {{ pump.location }}
                    </p>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="bi bi-clock"></i>
                            آخرین تغییر: 
                            {{ pump.last_change_jalali if pump.last_change_jalali else 'بدون تاریخچه' }}
                        </small>
                    </div>

                    <!-- دکمه‌های تغییر وضعیت - فقط برای چاه‌های فعال -->
                    {% if pump.well_status == 'active' %}
                    <div class="btn-group w-100" role="group">
                        <button 
                            class="btn btn-success btn-action btn-sm {{ 'disabled' if pump.status and pump.has_history > 0 }}"
                            onclick="changePumpStatus({{ pump.id }}, 'on')"
                            {{ 'disabled' if pump.status and pump.has_history > 0 }}>
                            <i class="bi bi-power"></i>
                            روشن
                        </button>
                        <button 
                            class="btn btn-danger btn-action btn-sm {{ 'disabled' if not pump.status and pump.has_history > 0 }}"
                            onclick="changePumpStatus({{ pump.id }}, 'off')"
                            {{ 'disabled' if not pump.status and pump.has_history > 0 }}>
                            <i class="bi bi-power-off"></i>
                            خاموش
                        </button>
                    </div>
                    {% else %}
                    <div class="alert alert-warning text-center py-2 mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            {% if pump.well_status == 'inactive' %}
                                چاه غیرفعال است
                            {% elif pump.well_status == 'maintenance' %}
                                چاه در حال تعمیر است
                            {% endif %}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- اطلاعات سیستم -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h5 class="text-success">{{ pumps|selectattr("status")|list|length }}</h5>
                            <small class="text-muted">پمپ‌های روشن</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-danger">{{ pumps|rejectattr("status")|list|length }}</h5>
                            <small class="text-muted">پمپ‌های خاموش</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-primary">{{ pumps|length }}</h5>
                            <small class="text-muted">کل پمپ‌ها</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-info">{{ session.role }}</h5>
                            <small class="text-muted">سطح دسترسی</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal برای تغییر وضعیت پمپ -->
<div class="modal fade" id="pumpModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">تغییر وضعیت پمپ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="pumpForm">
                    <input type="hidden" id="selectedPumpId">
                    <input type="hidden" id="selectedAction">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">شماره پمپ</label>
                            <input type="text" class="form-control" id="pumpNumber" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">نام پمپ</label>
                            <input type="text" class="form-control" id="pumpName" readonly>
                        </div>
                    </div>

                    <!-- فقط برای مدیران: تاریخ و زمان دستی -->
                    <div id="manualTimeSection" class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">تاریخ</label>
                            <input type="text" class="form-control" id="actionDateJalali" placeholder="1402/10/25" pattern="\d{4}/\d{2}/\d{2}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ساعت</label>
                            <input type="time" class="form-control" id="actionTime">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">علت تغییر وضعیت</label>
                        <select class="form-select" id="reason" required>
                            <option value="">-- انتخاب علت --</option>
                            <option value="قطع برق">قطع برق</option>
                            <option value="جلوگیری از سرریز مخزن">جلوگیری از سرریز مخزن</option>
                            <option value="خرابی">خرابی</option>
                            <option value="تعمیرات">تعمیرات</option>
                            <option value="برنامه ریزی شده">برنامه ریزی شده</option>
                            <option value="سایر">سایر</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">توضیحات</label>
                        <textarea class="form-control" id="notes" rows="3" 
                                  placeholder="توضیحات اضافی را وارد کنید..."></textarea>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <span id="actionSummary"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-primary" onclick="submitPumpChange()">ثبت تغییر</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function changePumpStatus(pumpId, action) {
        console.log('Opening modal for pump:', pumpId, action);
        
        // پیدا کردن اطلاعات پمپ
        const pumpCard = event.target.closest('.pump-card');
        const pumpNumber = pumpCard.querySelector('.card-header h6').textContent.replace('پمپ ', '');
        const pumpName = pumpCard.querySelector('.card-title').textContent;
        
        // پر کردن فرم
        document.getElementById('selectedPumpId').value = pumpId;
        document.getElementById('selectedAction').value = action;
        document.getElementById('pumpNumber').value = pumpNumber;
        document.getElementById('pumpName').value = pumpName;
        
        // تنظیم تاریخ و زمان پیشفرض
        const now = new Date();
        document.getElementById('actionDateJalali').value = '1404/07/19'; // خالی بذار
        document.getElementById('actionTime').value = now.toTimeString().split(' ')[0].substring(0, 5);
        
        // متن خلاصه عمل
        const actionText = action === 'on' ? 'روشن کردن' : 'خاموش کردن';
        document.getElementById('actionSummary').textContent = 
            `در حال ${actionText} پمپ ${pumpNumber} (${pumpName})`;
        
        // ریست کردن فرم
        document.getElementById('reason').value = '';
        document.getElementById('notes').value = '';
        
        // نمایش modal
        const modal = new bootstrap.Modal(document.getElementById('pumpModal'));
        modal.show();
    }

    function submitPumpChange() {
        const pumpId = document.getElementById('selectedPumpId').value;
        const action = document.getElementById('selectedAction').value;
        const reason = document.getElementById('reason').value;
        const notes = document.getElementById('notes').value;
        const actionDateJalali = document.getElementById('actionDateJalali').value;
        const actionTime = document.getElementById('actionTime').value;
        
        // اعتبارسنجی
        if (!reason) {
            alert('لطفا علت تغییر وضعیت را انتخاب کنید.');
            return;
        }
        
        // جمع‌آوری داده‌ها
        const formData = {
            pump_id: pumpId,
            action: action,
            reason: reason,
            notes: notes
        };
        
        // اگر تاریخ/زمان وارد کرده (برای همه کاربران)
        const isAdmin = '{{ session.role }}' === 'admin';
        if (actionDateJalali  && actionTime) {
            formData.action_date_jalali = actionDateJalali;
            formData.action_time = actionTime;
            formData.manual_time = true;
        }
        
        // نمایش حالت لودینگ
        const submitBtn = document.querySelector('#pumpModal .btn-primary');
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> در حال ثبت...';
        submitBtn.disabled = true;
        
        // ارسال درخواست
        fetch('/pump/change-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // بستن modal
                bootstrap.Modal.getInstance(document.getElementById('pumpModal')).hide();
                
                // نمایش پیام موفقیت
                alert(data.message);
                
                // رفرش صفحه
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('خطا در تغییر وضعیت: ' + data.error);
                submitBtn.innerHTML = 'ثبت تغییر';
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            alert('خطای شبکه: ' + error);
            submitBtn.innerHTML = 'ثبت تغییر';
            submitBtn.disabled = false;
        });
    }
</script>
{% endblock %}