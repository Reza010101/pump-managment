{% extends "base_dashboard.html" %}

{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">ğŸ—‚ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§</h4>
            </div>
            <div class="card-body">
                <!-- Ù‡Ø´Ø¯Ø§Ø± Ø¢Ù…ÙˆØ²Ø´ÛŒ -->
                <div class="alert alert-info">
                    <strong>â„¹ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù‡Ù…:</strong><br>
                    Ø´Ù…Ø§ ØªÙ†Ù‡Ø§ Ø§Ù…Ú©Ø§Ù† Ø­Ø°Ù <strong>Ø¢Ø®Ø±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ÛŒ Ú©Ù‡ Ø®ÙˆØ¯ØªØ§Ù† Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</strong> Ø±Ø§ Ø¯Ø§Ø±ÛŒØ¯. 
                    Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§Ø² Û´Û¸ Ø³Ø§Ø¹Øª Ù‚Ø§Ø¨Ù„ Ø­Ø°Ù Ù†ÛŒØ³ØªÙ†Ø¯.
                </div>

                <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ù…Ù¾ -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">ğŸ” Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ù…Ù¾</label>
                        <select class="form-select" id="pumpSelect">
                            <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ù…Ù¾ --</option>
                            {% for pump in pumps %}
                            <option value="{{ pump.id }}">
                                Ù¾Ù…Ù¾ {{ pump.pump_number }} - {{ pump.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Ø¬Ø¯ÙˆÙ„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ -->
                <div id="recordsTable" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 id="tableTitle"></h5>
                        <div id="paginationInfo" class="text-muted"></div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Ø±Ø¯ÛŒÙ</th>
                                    <th>ØªØ§Ø±ÛŒØ®</th>
                                    <th>Ø²Ù…Ø§Ù†</th>
                                    <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                    <th>Ú©Ø§Ø±Ø¨Ø±</th>
                                    <th>Ø¹Ù„Øª</th>
                                    <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="recordsBody">
                                <!-- Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ Ø¨Ø§ JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                            </tbody>
                        </table>
                    </div>

                    <!-- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ -->
                    <nav id="paginationNav" aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="paginationList">
                            <!-- ØµÙØ­Ø§Øª Ø¨Ø§ JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                        </ul>
                    </nav>
                </div>

                <!-- Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ -->
                <div id="emptyMessage" class="text-center text-muted py-4" style="display: none;">
                    Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ø­Ø°Ù -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ—‘ï¸ ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="recordInfo" class="mb-3">
                    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§ JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Ø¨Ø§ Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ØŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ù…Ù¾ Ø¨Ù‡ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„ Ø¨Ø§Ø²Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.
                </div>

                <div class="mb-3">
                    <label class="form-label">ğŸ” Ø¯Ù„ÛŒÙ„ Ø­Ø°Ù</label>
                    <textarea class="form-control" id="deletionReason" rows="3" 
                              placeholder="Ø¯Ù„ÛŒÙ„ Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ø±Ø§ Ø´Ø±Ø­ Ø¯Ù‡ÛŒØ¯ (Ø­Ø¯Ø§Ù‚Ù„ Û±Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)" 
                              minlength="10" required></textarea>
                    <div class="form-text">Ø­Ø¯Ø§Ù‚Ù„ Û±Û° Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">âŒ Ø§Ù†ØµØ±Ø§Ù</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">âœ… ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Ú©Ø¯ JavaScript Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§
let currentPumpId = null;
let currentPage = 1;
let selectedRecordId = null;

// ÙˆÙ‚ØªÛŒ Ù¾Ù…Ù¾ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯
document.getElementById('pumpSelect').addEventListener('change', function() {
    currentPumpId = this.value;
    currentPage = 1;
    
    if (currentPumpId) {
        loadPumpRecords(currentPumpId, currentPage);
    } else {
        hideRecordsTable();
    }
});

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù¾Ù…Ù¾
async function loadPumpRecords(pumpId, page) {
    try {
        showLoading();
        
        const response = await fetch(`/api/records/pump/${pumpId}?page=${page}`);
        const data = await response.json();
        
        if (data.success) {
            displayRecords(data.records, data.pagination);
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§');
    }
}

// Ù†Ù…Ø§ÛŒØ´ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ Ø¯Ø± Ø¬Ø¯ÙˆÙ„
function displayRecords(records, pagination) {
    const tbody = document.getElementById('recordsBody');
    tbody.innerHTML = '';
    
    if (records.length === 0) {
        showEmptyMessage();
        return;
    }
    
    // Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙˆÙ„
    document.getElementById('tableTitle').textContent = 
        `ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ù…Ù¾ ${records[0].pump_number} - ${records[0].pump_name}`;
    
    // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§
    records.forEach((record, index) => {
        const row = document.createElement('tr');
        
        // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¨Ù‡ Ø´Ù…Ø³ÛŒ (Ø³Ø§Ø¯Ù‡)
        const eventDate = new Date(record.event_time);
        const jalaliDate = eventDate.toLocaleDateString('fa-IR');
        const jalaliTime = eventDate.toLocaleTimeString('fa-IR', { 
            hour: '2-digit', minute: '2-digit' 
        });
        
        row.innerHTML = `
            <td>${((currentPage - 1) * 20) + index + 1}</td>
            <td>${jalaliDate}</td>
            <td>${jalaliTime}</td>
            <td>
                <span class="badge ${record.action === 'ON' ? 'bg-success' : 'bg-danger'}">
                    ${record.action === 'ON' ? 'Ø±ÙˆØ´Ù†' : 'Ø®Ø§Ù…ÙˆØ´'}
                </span>
            </td>
            <td>${record.user_full_name}</td>
            <td>${record.reason}</td>
            <td>${record.notes || '-'}</td>
            <td>
                ${index === 0 ? 
                    `<button class="btn btn-sm btn-danger" onclick="openDeleteModal(${record.id})" 
                      data-bs-toggle="tooltip" data-bs-placement="top">
                        ğŸ—‘ï¸ Ø­Ø°Ù
                    </button>` 
                    : ''
                }
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
    displayPagination(pagination);
    showRecordsTable();
}

// Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
function displayPagination(pagination) {
    const paginationList = document.getElementById('paginationList');
    const paginationInfo = document.getElementById('paginationInfo');
    
    paginationList.innerHTML = '';
    paginationInfo.textContent = 
        `ØµÙØ­Ù‡ ${pagination.current_page} Ø§Ø² ${pagination.total_pages} - 
         ${pagination.total_records} Ø±Ú©ÙˆØ±Ø¯`;
    
    // Ø¯Ú©Ù…Ù‡ Ù‚Ø¨Ù„ÛŒ
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${pagination.current_page === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(${pagination.current_page - 1})">Ù‚Ø¨Ù„ÛŒ</a>
    `;
    paginationList.appendChild(prevLi);
    
    // ØµÙØ­Ø§Øª
    for (let i = 1; i <= pagination.total_pages; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
        pageLi.innerHTML = `
            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
        `;
        paginationList.appendChild(pageLi);
    }
    
    // Ø¯Ú©Ù…Ù‡ Ø¨Ø¹Ø¯ÛŒ
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${pagination.current_page === pagination.total_pages ? 'disabled' : ''}`;
    nextLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(${pagination.current_page + 1})">Ø¨Ø¹Ø¯ÛŒ</a>
    `;
    paginationList.appendChild(nextLi);
}

// ØªØºÛŒÛŒØ± ØµÙØ­Ù‡
function changePage(page) {
    currentPage = page;
    loadPumpRecords(currentPumpId, currentPage);
}

// Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Modal Ø­Ø°Ù
async function openDeleteModal(recordId) {
    selectedRecordId = recordId;
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ú©Ø§Ù† Ø­Ø°Ù
    const response = await fetch(`/api/records/check-delete/${recordId}`);
    const data = await response.json();
    
    if (data.success && data.can_delete) {
        // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± Modal
        document.getElementById('recordInfo').innerHTML = `
            <strong>ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ú©ÙˆØ±Ø¯:</strong><br>
            â€¢ Ù¾Ù…Ù¾: ${currentPumpId}<br>
            â€¢ ÙˆØ¶Ø¹ÛŒØª: ${data.record_action === 'ON' ? 'Ø±ÙˆØ´Ù†' : 'Ø®Ø§Ù…ÙˆØ´'}<br>
            â€¢ Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡: ${data.original_user}
        `;
        
        // Ù†Ù…Ø§ÛŒØ´ Modal
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    } else {
        alert(data.message || 'Ø§Ù…Ú©Ø§Ù† Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
    }
}

// ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù
document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    const deletionReason = document.getElementById('deletionReason').value.trim();
    
    if (deletionReason.length < 10) {
        alert('Ù„Ø·ÙØ§ Ø¯Ù„ÛŒÙ„ Ø­Ø°Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø­Ø¯Ø§Ù‚Ù„ Û±Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)');
        return;
    }
    
    try {
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù...';
        
        const response = await fetch('/api/records/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                record_id: selectedRecordId,
                deletion_reason: deletionReason
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Ø¨Ø³ØªÙ† Modal
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
            alert(data.message);
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§
            loadPumpRecords(currentPumpId, currentPage);
            
            // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ÙØ±Ù…
            document.getElementById('deletionReason').value = '';
        } else {
            alert('Ø®Ø·Ø§: ' + data.error);
        }
    } catch (error) {
        alert('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ' + error);
    } finally {
        this.disabled = false;
        this.innerHTML = 'âœ… ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù';
    }
});

// ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
function showRecordsTable() {
    document.getElementById('recordsTable').style.display = 'block';
    document.getElementById('emptyMessage').style.display = 'none';
}

function hideRecordsTable() {
    document.getElementById('recordsTable').style.display = 'none';
    document.getElementById('emptyMessage').style.display = 'none';
}

function showEmptyMessage() {
    document.getElementById('recordsTable').style.display = 'none';
    document.getElementById('emptyMessage').style.display = 'block';
}

function showLoading() {
    document.getElementById('recordsBody').innerHTML = `
        <tr>
            <td colspan="8" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                </div>
            </td>
        </tr>
    `;
}

function showError(message) {
    document.getElementById('recordsBody').innerHTML = `
        <tr>
            <td colspan="8" class="text-center text-danger">
                âŒ ${message}
            </td>
        </tr>
    `;
}

// ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† tooltipâ€ŒÙ‡Ø§
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}