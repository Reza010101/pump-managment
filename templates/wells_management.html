<!-- templates/wells_management.html -->
{% extends "base_dashboard.html" %}

{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª Ú†Ø§Ù‡â€ŒÙ‡Ø§{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">ğŸ­ Ù…Ø¯ÛŒØ±ÛŒØª Ú†Ø§Ù‡â€ŒÙ‡Ø§</h4>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="toggleSearch()">
                        <i class="bi bi-search"></i> Ø¬Ø³ØªØ¬Ùˆ
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Ø¨Ø®Ø´ Ø¬Ø³ØªØ¬Ùˆ -->
                <div id="searchSection" class="mb-4" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" id="searchInput" class="form-control" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù…Ø§Ø±Ù‡ Ú†Ø§Ù‡ØŒ Ù†Ø§Ù…ØŒ Ù…ÙˆÙ‚Ø¹ÛŒØªØŒ Ø¨Ø±Ù†Ø¯ Ù¾Ù…Ù¾...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="performSearch()">
                                <i class="bi bi-search"></i> Ø§Ø¬Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ
                            </button>
                        </div>
                    </div>
                    <div id="searchResults" class="mt-3"></div>
                </div>

                <!-- Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center py-3">
                                <h4>{{ wells|length }}</h4>
                                <small>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú†Ø§Ù‡â€ŒÙ‡Ø§</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center py-3">
                                <h4>{{ wells|selectattr("pump_status")|selectattr("pump_status")|list|length }}</h4>
                                <small>Ú†Ø§Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center py-3">
                                <h4>{{ wells|selectattr("status")|select("equalto", "maintenance")|list|length }}</h4>
                                <small>Ø¯Ø± Ø­Ø§Ù„ ØªØ¹Ù…ÛŒØ±</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center py-3">
                                <h4>{{ wells|selectattr("created_at_jalali")|list|length }}</h4>
                                <small>Ú†Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ø¬Ø¯ÙˆÙ„ Ú†Ø§Ù‡â€ŒÙ‡Ø§ -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Ø´Ù…Ø§Ø±Ù‡ Ú†Ø§Ù‡</th>
                                <th>Ù†Ø§Ù…</th>
                                <th>Ù…ÙˆÙ‚Ø¹ÛŒØª</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª Ù¾Ù…Ù¾</th>
                                <th>Ø¨Ø±Ù†Ø¯ Ù¾Ù…Ù¾</th>
                                <th>Ù‚Ø¯Ø±Øª Ù¾Ù…Ù¾</th>
                                <th>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for well in wells %}
                            <tr>
                                <td>
                                    <strong>Ú†Ø§Ù‡ {{ well.well_number }}</strong>
                                </td>
                                <td>{{ well.name }}</td>
                                <td>{{ well.location or '-' }}</td>
                                <td>
                                    <span class="badge {% if well.pump_status %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if well.pump_status %}
                                            <i class="bi bi-power"></i> Ø±ÙˆØ´Ù†
                                        {% else %}
                                            <i class="bi bi-power-off"></i> Ø®Ø§Ù…ÙˆØ´
                                        {% endif %}
                                    </span>
                                </td>
                                <td>{{ well.current_pump_brand or '-' }}</td>
                                <td>{{ well.current_pump_power or '-' }}</td>
                                <td>{{ well.created_at_jalali or '-' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/wells/{{ well.id }}" class="btn btn-info" 
                                           data-bs-toggle="tooltip" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="/wells/{{ well.id }}/edit" class="btn btn-warning"
                                           data-bs-toggle="tooltip" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="/wells/{{ well.id }}/maintenance" class="btn btn-primary"
                                           data-bs-toggle="tooltip" title="Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ù…ÛŒØ±Ø§Øª">
                                            <i class="bi bi-tools"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ -->
                {% if not wells %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-water" style="font-size: 3rem;"></i>
                    <p class="mt-3">Ù‡ÛŒÚ† Ú†Ø§Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleSearch() {
    const searchSection = document.getElementById('searchSection');
    searchSection.style.display = searchSection.style.display === 'none' ? 'block' : 'none';
}

async function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (searchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">Ø­Ø¯Ø§Ù‚Ù„ Û² Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ù†ÛŒØ§Ø² Ø§Ø³Øª</div>';
        return;
    }
    
    try {
        resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
        
        const response = await fetch(`/api/wells/search?q=${encodeURIComponent(searchTerm)}`);
        const data = await response.json();
        
        if (data.success && data.results.length > 0) {
            let html = '<div class="alert alert-success">' + data.results.length + ' Ù†ØªÛŒØ¬Ù‡ ÛŒØ§ÙØª Ø´Ø¯</div>';
            html += '<div class="list-group">';
            
            data.results.forEach(well => {
                html += `
                    <a href="/wells/${well.id}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Ú†Ø§Ù‡ ${well.well_number} - ${well.name}</h6>
                            <span class="badge ${well.pump_status ? 'bg-success' : 'bg-danger'}">
                                ${well.pump_status ? 'Ø±ÙˆØ´Ù†' : 'Ø®Ø§Ù…ÙˆØ´'}
                            </span>
                        </div>
                        <p class="mb-1">${well.location || 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª'}</p>
                    </a>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = '<div class="alert alert-warning">Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
        }
    } catch (error) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ</div>';
    }
}

// ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Enter
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        performSearch();
    }
});

// ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† tooltipâ€ŒÙ‡Ø§
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}